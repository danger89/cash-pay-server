

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: routes/invoice/index.js | CashPayServer</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <a href="https://infra.cash" rel="noopener noreferrer" target="_blank">
                <img src="https://raw.githubusercontent.com/developers-cash/cash-pay-server/master/logo.svg" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">CashPayServer</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Guide</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Guide</h3><ul><li><a href="tutorial-REST-API.html">REST-API</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="REST-API_sub"></div></li><li><a href="tutorial-Webhooks.html">Webhooks</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Webhooks_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="Authenticate.html">Authenticate</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Authenticate_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Authenticate.html#.isAPIKeyAllowed">isAPIKeyAllowed</a></li></ul></div></li><li><a href="Engine.html">Engine</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Engine_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Engine.html#broadcastTx">broadcastTx</a></li><li><a href="Engine.html#start">start</a></li></ul></div></li><li><a href="Libs.Utils.html">Utils</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Libs.Utils_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Libs.Utils.html#.matchesInvoice">matchesInvoice</a></li></ul></div></li><li><a href="Protocols.BIP70.html">BIP70</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Protocols.BIP70_sub"></div></li><li><a href="Protocols.JSONPaymentProtocol.html">JSONPaymentProtocol</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Protocols.JSONPaymentProtocol_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Protocols.JSONPaymentProtocol.html#.payment">payment</a></li><li><a href="Protocols.JSONPaymentProtocol.html#.paymentRequest">paymentRequest</a></li><li><a href="Protocols.JSONPaymentProtocol.html#.paymentVerification">paymentVerification</a></li></ul></div></li><li><a href="Rates.html">Rates</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Rates_sub"></div></li><li><a href="Routes.AdminRoute.html">AdminRoute</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Routes.AdminRoute_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Routes.AdminRoute.html#postSearch">postSearch</a></li></ul></div></li><li><a href="Routes.InvoiceRoute.html">InvoiceRoute</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Routes.InvoiceRoute_sub"></div></li><li><a href="Routes.RootRoute.html">RootRoute</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Routes.RootRoute_sub"></div></li><li><a href="Routes.SigningKeysRoute.html">SigningKeysRoute</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Routes.SigningKeysRoute_sub"></div></li><li><a href="Services.Webhooks.html">Webhooks</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Services.Webhooks_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Services.Webhooks.html#.error">error</a></li><li><a href="Services.Webhooks.html#broadcasted">broadcasted</a></li><li><a href="Services.Webhooks.html#broadcasting">broadcasting</a></li><li><a href="Services.Webhooks.html#confirmed">confirmed</a></li><li><a href="Services.Webhooks.html#requested">requested</a></li></ul></div></li><li><a href="Services.WebSocket.html">WebSocket</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Services.WebSocket_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Services.WebSocket.html#notify">notify</a></li><li><a href="Services.WebSocket.html#startServer">startServer</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Namespaces</h3><ul><li><a href="Libs.html">Libs</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Libs_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Libs.html#.ExtendedError">ExtendedError</a></li></ul></div></li><li><a href="Protocols.html">Protocols</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Protocols_sub"></div></li><li><a href="Routes.html">Routes</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Routes_sub"></div></li><li><a href="Services.html">Services</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Services_sub"></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const express = require('express')
const router = express.Router()

// Utils/Libs
const ExtError = require('../../libs/extended-error')
const Invoice = require('../../models/invoices')

// Middlewares
const Authenticate = require('../../middlewares/authenticate')

// Services
const webSocket = require('../../services/websocket')

// Protocols
const BIP70 = require('../../protocols/bip70')
const JSONPaymentProtocol = require('../../protocols/json-payment-protocol')

// Validation
var validate = require('jsonschema').validate

/**
  * Routes pertaining to invoice creation
  * @memberof Routes
  */
class InvoiceRoute {
  constructor () {
    // Define the routes
    router.all('/create', Authenticate.isAPIKeyAllowed, (req, res) => this.postCreate(req, res))
    router.get('/pay/:invoiceId', (req, res) => this.getPay(req, res))
    router.post('/pay/:invoiceId', (req, res) => this.postPay(req, res))

    return router
  }

  async postCreate (req, res) {
    try {
      // Validate the payload...
      try {
        validate(req.body, this._onCreateSchema(), {
          throwFirst: true
        })
      } catch (err) {
        const firstError = err.errors[0]
        throw new ExtError(`${firstError.property} ${firstError.message}`, 400)
      }

      // Create the payment in MongoDB
      const invoiceDB = await Invoice.create(req.body)

      // Send full payload to client (including 'options')
      res.send(invoiceDB.payload())
    } catch (err) {
      console.log(err)
      return res.status(err.httpStatusCode || 500).send(err.message)
    }
  }

  async getPay (req, res) {
    // Define this here so we have access to it in the "catch"
    let invoiceDB = null

    this._setupEvent(req, res)

    try {
      // Retrieve Invoice from Database
      invoiceDB = await Invoice.findById(req.params.invoiceId)
      if (!invoiceDB) {
        throw new ExtError('Invoice ID does not exist.', { httpStatusCode: 404 })
      }

      // Make sure invoice has not expired
      if (Date.now() > new Date(invoiceDB.expires * 1000)) {
        throw new ExtError('Invoice has expired.', { httpStatusCode: 403 })
      }

      // Make sure transaction has not already been broadcast
      if (invoiceDB.hasEvent('broadcasted')) {
        throw new ExtError('Invoice already paid.', { httpStatusCode: 403 })
      }

      //
      // BIP70 Payment Request
      //
      if (req.get('accept') === 'application/bitcoincash-paymentrequest') {
        return await BIP70.paymentRequest(req, res, invoiceDB)
      }

      //
      // JSON Payment Protocol Request
      //
      if (req.get('accept') === 'application/payment-request') {
        return await JSONPaymentProtocol.paymentRequest(req, res, invoiceDB)
      }

      throw new ExtError('Unsupported payment type.', { httpStatusCode: 400 })
    } catch (err) {
      // Set event state
      res.locals.event.status = res.locals.event.status || 'failed'
      res.locals.event.message = err.message

      // Send error to wallet
      if (!res.writableEnded) {
        res.status(err.httpStatusCode || 500).send(err.message)
      }

      // Notify any Websockets that might be listening
      webSocket.notify(invoiceDB._id, 'failed', {
        message: err.message,
        details: err.details || {}
      })
    } finally {
      // Save event log
      if (invoiceDB) {
        invoiceDB.events.push(res.locals.event)
        invoiceDB.save()
      }
    }
  }

  async postPay (req, res) {
    let invoiceDB = null

    this._setupEvent(req, res)

    try {
      // Retrieve Invoice from Database
      invoiceDB = await Invoice.findById(req.params.invoiceId)
      if (!invoiceDB) {
        throw new ExtError('Invoice ID does not exist.', { httpStatusCode: 404 })
      }

      // Make sure transaction has not already been broadcast
      if (invoiceDB.hasEvent('broadcasted')) {
        throw new ExtError('Invoice already paid.', { httpStatusCode: 403 })
      }

      // Make sure invoice has not expired
      if (Date.now() > new Date(invoiceDB.expires * 1000)) {
        throw new ExtError('Invoice has expired.', { httpStatusCode: 403 })
      }

      //
      // BIP70 Payment Ack
      //
      if (req.get('accept') === 'application/bitcoincash-paymentack') {
        return await BIP70.paymentAck(req, res, invoiceDB)
      }

      //
      // JSON Payment Protocol Payment Verification
      //
      if (req.get('content-type') === 'application/verify-payment') {
        return await JSONPaymentProtocol.paymentVerification(req, res, invoiceDB)
      }

      //
      // JSON Payment Protocol Payment
      //
      if (req.get('content-type') === 'application/payment') {
        return await JSONPaymentProtocol.payment(req, res, invoiceDB)
      }

      throw new ExtError('Unsupported payment type.', { httpStatusCode: 400 })
    } catch (err) {
      console.log(err)

      res.locals.event.status = res.locals.event.status || 'failed'
      res.locals.event.message = err.message

      // Send error to wallet
      if (!res.writableEnded) {
        res.status(err.httpStatusCode || 500).send(err.message)
      }

      // Notify any Websockets that might be listening
      webSocket.notify(invoiceDB._id, 'failed', {
        message: err.message,
        details: err.details || {}
      })
    } finally {
      // Save event log
      if (invoiceDB) {
        invoiceDB.events.push(res.locals.event)
        invoiceDB.save()
      }
    }
  }

  _setupEvent (req, res) {
    res.locals.event = {
      userAgent: req.get('user-agent'),
      requestedWith: req.get('x-requested-with'),
      ip: req.ip,
      req: {
        method: req.method,
        headers: JSON.stringify(req.headers),
        body: req.body ? req.body instanceof Buffer ? req.body.toString('base64') : JSON.stringify(req.body) : undefined
      },
      res: {
        headers: undefined,
        payload: undefined
      }
    }
  }

  _onCreateSchema () {
    return {
      type: 'object',
      properties: {
        apiKey: { type: 'string', maxLength: 128 },
        currency: { type: 'String', maxLength: 8 },
        network: { type: 'string', maxlength: 8 },
        outputs: {
          type: 'array',
          items: {
            properties: {
              amount: { type: ['integer', 'string'] },
              address: { type: 'string' },
              script: { type: 'string' }
            },
            additionalProperties: false
          }
        },
        expires: { type: 'integer', minimum: 30, maximum: 24 * 60 * 60 },
        merchantData: { type: 'string', maxLength: 2048 },
        data: { type: 'string', maxLength: 2048 },
        privateData: { type: 'string', maxLength: 2048 },
        userCurrency: { type: 'string', maxLength: 8 },
        webhook: {
          type: 'object',
          properties: {
            broadcasting: { type: 'string' },
            broadcasted: { type: 'string' },
            confirmed: { type: 'string' }
          },
          additionalProperties: false
        }
      },
      additionalProperties: false
    }
  }
}

module.exports = new InvoiceRoute()
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://raw.githubusercontent.com/developers-cash/cash-pay-server/master/logo.svg" style="">
    <div class="footer-text">CashPayServer V1</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
